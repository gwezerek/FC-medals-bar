<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width">
	<title>Medal Totals</title>
	<link rel="stylesheet" href="css/site.css">
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
</head>

<body>
	<article class="graphic-article">
		<div class="graphic-container">
			<div id="chart"> 
				<span class="graphic-dek">Which Countries Will Win&nbsp;Big?</span>
				<span class="graphic-copy">According to the Graettingers' model, the United States will walk away once more with the most overall medals, though it won't come close to last year's record-setting 37 individual awards. China, which only won 11 medals in the last Winter Games, is set to double its haul. Hover over each bar to see individual values for the four parameters the Graettingers modeled.</span>
			</div>
			<span class="sources-copy">SOURCES: CIA World Factbook, Wikipedia</span>
		</div>

		<!-- D3 LAYOUT -->
		<script type="text/javascript">

			// Accessor functions 
			var nation = function(d) { return d['Nation']; };
			var predicted = function(d) { return d['Predicted']; };
			var actual = function(d) { return d['Actual']; };

			var margin = {top: 20, right: 20, bottom: 30, left: 40},
				width = parseInt(d3.select('#chart').style('width'), 10),
				height = 480 - margin.top - margin.bottom;

			var x = d3.scale.linear()
				.range([0, width - margin.left - margin.right]);

			var y = d3.scale.linear()
				.range([height, 0]);

			var color = d3.scale.category10();

			var xAxis = d3.svg.axis()
				.scale(x)
				.ticks(5)
				.orient("bottom");

			var yAxis = d3.svg.axis()
				.scale(y)
				.ticks(5)
				.orient("left");

			var svg = d3.select("#chart").append("svg")
				.attr("width", width)
				.attr("height", height + margin.top + margin.bottom)
			  .append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			d3.tsv("outliers.tsv", function(error, data) {
			  data.forEach(function(d) {
				d.Actual = +d.Actual;
				d.Predicted = +d.Predicted;
			  });

			  x.domain(d3.extent(data, function(d) { return d.Predicted; })).nice();
			  y.domain(d3.extent(data, function(d) { return d.Actual; })).nice();

			var slopeRadians =  Math.atan2(height - y(50), x(50)),
					slopeDegrees = (slopeRadians * 180 / Math.PI);

			// X-axis
			svg.append("g")
				  .attr("class", "x axis")
				  .attr("transform", "translate(0," + height + ")")
				  .call(xAxis)
				.append("text")
				  .attr("class", "axis-label")
				  .attr("x", width - margin.left - margin.right)
				  .attr("y", -6)
				  .style("text-anchor", "end")
				  .text("Total Predicted Medals, '06 and '10");

			// Y-axis
			svg.append("g")
				  .attr("class", "y axis")
				  .call(yAxis)
				.append("text")
				  .attr("class", "axis-label")
				  .attr("transform", "rotate(-90)")
				  .attr("y", 6)
				  .attr("dy", ".71em")
				  .style("text-anchor", "end")
				  .text("Total Actual Medals, '06 and '10")

			// Model
			var model = svg.append("g")
					.attr("class", "model-line-container");

			var modelLine = model.append("line")
				  .attr("class", "model-line")
				  .attr("x1", x(0))
				  .attr("x2", x(100))
				  .attr("y1", y(0))
				  .attr("y2", y(100));

			var modelOver = model.append("text")
		    .attr("class", "model-line-label over")
		    .attr("text-anchor", "middle")
				.attr("x", x(0))
		    .attr("y", y(0))
		    .attr("transform", "rotate(-" + slopeDegrees + ",0," + height + "), translate("+x(60)+", -7)")
		    .text("Beat Expectations ▲");

	    var modelUnder = model.append("text")
		    .attr("class", "model-line-label under")
		    .attr("text-anchor", "middle")
				.attr("x", x(0))
		    .attr("y", y(0))
		    .attr("transform", "rotate(-" + slopeDegrees + ",0," + height + "), translate("+x(60)+", 15)")
		    .text("Wow So Shame ▼");


			// Points
			var dotContainer = svg.selectAll("g .dot-container")
				  .data(data)
					.enter()
				.append("g")
					.attr("class", function(d) {          
						if (d.Predicted <= d.Actual) {return "dot-container over"}
						else { return "dot-container under" };        
				  })
					.attr("transform", function(d) { return "translate(" + x(d.Predicted) + "," + y(d.Actual) + ")"; });
					
			dotContainer.on("mouseover", function(d) { 
		  		// Dot transition   
				  d3.select(this).select(".dot").transition()        
							.duration(200)      
							.attr("r", 6) 

					// Magnitude transition
					d3.select(this).select(".magnitude").transition()
							.duration(200)
							.attr("y1", "0")

					// Label transition
					d3.select(this).select(".dot-label").transition()
							.duration(200)
							.style("opacity", 0); 

					// Tooltip transition
					div.transition()        
							.duration(200)      
							.style("opacity", 1);      
					div .html(
							"<span class='tootltip-title'>"+ nation(d) +"</span><br/>" +
							"<span class='tooltip-param'>Predicted: "+ predicted(d) +" medals</span><br/>" +
							"<span class='tooltip-param'>Actual: "+ actual(d) +" medals</span>"
					)
					.style("left", (d3.event.pageX + 10) + "px")     
					.style("top", (d3.event.pageY - 20) + "px");  
			})  

			dotContainer.on("mouseout", function(d) {  
					// Dot transition
					d3.select(this).select(".dot").transition()        
							.duration(500)      
							.attr("r", 4)  

					// Magnitude transition
					magnitude.transition()
							.duration(200)
							.attr("y1", function(d) { return -(y(d.Actual) - y(d.Predicted)) ;} )

					// Label transition
					d3.select(this).select(".dot-label").transition()
							.duration(200)
							.style("opacity", 1); 

					// Tooltip transition    
					div.transition()        
							.duration(500)      
							.style("opacity", 0);   
			})


			var magnitude = dotContainer.append("line")
					.attr("class", "magnitude")
					.attr("x1", "0")
				  .attr("x2", "0")
				  .attr("y1", function(d) { return -(y(d.Actual) - y(d.Predicted)) ;} )
				  .attr("y2", function(d) { return -(y(d.Actual) - y(d.Predicted)) ;} );

			var dot = dotContainer.append("circle")
				  .attr("r", 4)
				  .attr("class", "dot")

			var dotLabels = dotContainer.append("text")
					.attr("dy", "-.7em")
					.attr("class", "dot-label")
					.text(function(d) { 
						if (["United States","Russia","China","South Korea","United Kingdom","Germany","Austria"].indexOf(d.Nation) > -1) { return d.Nation; } 

					});


			// Tooltipz
			var div = d3.select("body").append("div")   
				.attr("class", "tooltip")               
				.style("opacity", 0);


			});

	</script>

</article>
</body>
</html>


